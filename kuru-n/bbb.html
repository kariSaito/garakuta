<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>3D 3段クルーン抽選機 (Local)</title>
    <style>
        body { margin: 0; background: #111; overflow: hidden; font-family: sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; color: white; z-index: 10; }
        button { padding: 12px 24px; font-size: 18px; cursor: pointer; background: #f1c40f; border: none; border-radius: 8px; font-weight: bold; }
        button:hover { background: #d4af37; }
    </style>
</head>
<body>
    <div id="ui">
        <h1>3D 3-Tier Croon</h1>
        <button onclick="launchBall()">ボール投入！</button>
    </div>

    <!-- ローカルファイルを指定 -->
    <script type="importmap">
        {
            "imports": {
                "three": "./three.module.js",
                "cannon-es": "./cannon-es.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import * as CANNON from 'cannon-es';

        // シーン・カメラ設定
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 12, 18);
        camera.lookAt(0, 2, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x1a1a1a);
        document.body.appendChild(renderer.domElement);

        // 照明
        const ambientLight = new THREE.AmbientLight(0x606060);
        scene.add(ambientLight);
        const sunLight = new THREE.DirectionalLight(0xffffff, 1);
        sunLight.position.set(10, 20, 10);
        scene.add(sunLight);

        // 物理演算の世界
        const world = new CANNON.World({ gravity: new CANNON.Vec3(0, -9.82, 0) });

        // 皿の作成
        function createDish(y, holeIndex) {
            const segs = 18;
            const radius = 4;
            for (let i = 0; i < segs; i++) {
                if (i === holeIndex) continue; // 穴の部分だけ隙間を空ける

                const angle = (i / segs) * Math.PI * 2;
                const body = new CANNON.Body({ mass: 0 });
                const shape = new CANNON.Box(new CANNON.Vec3(1, 0.1, 2));
                body.addShape(shape);
                body.position.set(Math.cos(angle) * 2.5, y, Math.sin(angle) * 2.5);
                body.quaternion.setFromEuler(-0.6, angle + Math.PI / 2, 0);
                world.addBody(body);

                // 視覚的な皿（簡易表示）
                const mesh = new THREE.Mesh(
                    new THREE.BoxGeometry(2, 0.1, 4),
                    new THREE.MeshPhongMaterial({ color: 0x777777 })
                );
                mesh.position.copy(body.position);
                mesh.quaternion.copy(body.quaternion);
                scene.add(mesh);
            }
        }

        createDish(6, 0);   // 上段
        createDish(1, 6);   // 中段
        createDish(-4, 12); // 下段

        const balls = [];
        const ballGeo = new THREE.SphereGeometry(0.2, 16, 16);
        const ballMat = new THREE.MeshPhongMaterial({ color: 0xff0000 });

        window.launchBall = () => {
            const ballBody = new CANNON.Body({
                mass: 1,
                shape: new CANNON.Sphere(0.2),
                position: new CANNON.Vec3(3, 11, 0)
            });
            ballBody.velocity.set(0, 0, 5); // 横回転の初速
            world.addBody(ballBody);

            const ballMesh = new THREE.Mesh(ballGeo, ballMat);
            scene.add(ballMesh);
            balls.push({ body: ballBody, mesh: ballMesh });
        };

        function animate() {
            requestAnimationFrame(animate);
            world.fixedStep();
            balls.forEach(b => {
                b.mesh.position.copy(b.body.position);
                b.mesh.quaternion.copy(b.body.quaternion);
            });
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>